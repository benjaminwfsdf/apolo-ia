<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Apolo ‚Äî Or√°culo del Conocimiento</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0b0c">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Apolo">

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Forum&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#d4af37;
      --gold-2:#f1c40f;
      --bg:#0b0b0c;
      --panel:#151515cc;
      --ink:#f4e9d8;
      --muted:#cfc6b6;
      --accent:#caa64a;
      --radius:18px;
      --shadow:0 25px 50px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background: var(--bg) url("https://upload.wikimedia.org/wikipedia/commons/3/33/Temple_of_Apollo_in_Corinth.jpg") center/cover fixed no-repeat;
      font-family:'Forum', serif;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      position:relative;
    }
    body::before{
      content:""; position:fixed; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.65));
      z-index:-1;
    }

    .oracle{
      width:min(780px, 100%);
      background:var(--panel);
      border-radius:var(--radius);
      border: 2px solid rgba(212,175,55,.35);
      box-shadow: var(--shadow);
      padding:28px 22px 20px;
      backdrop-filter: blur(6px);
      position:relative;
      overflow:hidden;
    }

    .meander{
      height:22px; opacity:.25; pointer-events:none;
      background:url('https://upload.wikimedia.org/wikipedia/commons/f/f9/Greek_meander_pattern.svg') center/contain repeat-x;
      filter:contrast(0) brightness(2);
      margin:-8px -22px 14px;
    }

    .title{
      margin:0 0 6px;
      text-align:center;
      font-family:"Playfair Display", serif;
      letter-spacing:.5px;
      font-size:clamp(26px,4.2vw,36px);
      color:var(--gold);
      text-shadow:0 1px 0 #000, 0 0 16px rgba(212,175,55,.35);
    }
    .subtitle{
      text-align:center; margin:0 0 12px; color:var(--muted);
      letter-spacing:.2px;
    }

    .controls{ display:grid; gap:10px; grid-template-columns: 1fr; margin:12px 0 4px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > * { flex:1 1 auto; }

    input[type="text"]{
      width:100%; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:#0e0e10; color:var(--ink); font-size:16px; outline:none;
    }

    .btn{
      appearance:none; border:1px solid rgba(212,175,55,.45);
      background:linear-gradient(180deg, #1a1a1a, #101010);
      color:var(--ink); padding:12px 14px; border-radius:12px;
      font-weight:700; cursor:pointer; transition:.15s transform, .2s box-shadow, .2s background;
      text-align:center;
    }
    .btn:hover{ box-shadow:0 0 0 2px rgba(212,175,55,.25) inset; }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{
      background:linear-gradient(90deg, var(--gold), var(--gold-2));
      color:#2a2105; border:0; font-weight:900;
    }

    .toggles{ display:flex; gap:8px; flex-wrap:wrap; }
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; background:#0f0f10; border:1px solid rgba(255,255,255,.12);
      border-radius:999px; cursor:pointer; user-select:none;
    }
    .toggle input{ accent-color:var(--gold); }

    .status{
      margin:8px 2px 0; font-size:14px; color:#dfd3bb;
      display:flex; align-items:center; gap:8px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#666; }
    .dot.live{ background:#27ae60; box-shadow:0 0 0 3px rgba(39,174,96,.2); }

    .answer{
      margin-top:14px; background:#101011; border:1px solid rgba(255,255,255,.09);
      border-radius:14px; padding:16px; line-height:1.6; font-size:17px;
      position:relative;
    }
    .answer .tools{
      position:absolute; top:10px; right:10px; display:flex; gap:6px;
    }
    .chip{
      background:#161616; color:#e9dec9; border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:6px 10px; font-size:13px; cursor:pointer;
    }

    .history{ margin:16px 2px 2px; padding-top:10px; border-top:1px dashed rgba(255,255,255,.15); }
    .history h3{ margin:0 0 8px; font-size:16px; color:#e7d9bf; }
    .q{ color:#f1e8d7; margin:6px 0 2px; }
    .a{ color:#d8cfbf; margin:0 0 8px; opacity:.9; }

    @media (max-width: 640px){
      .row{ flex-direction:column; }
    }
  </style>
</head>
<body>
  <main class="oracle">
    <div class="meander"></div>
    <h1 class="title">APOŒõŒõŒ©N</h1>
    <p class="subtitle">Or√°culo del Conocimiento</p>

    <div id="saludo" class="status"><span class="dot" id="dot"></span><span>Cargando saludo‚Ä¶</span></div>

    <div class="controls">
      <div class="row">
        <input id="texto" type="text" placeholder="Escribe tu pregunta al or√°culo‚Ä¶" autocomplete="off" />
        <button id="btnPreguntar" class="btn primary">Preguntar</button>
      </div>
      <div class="row">
        <button id="btnHablar" class="btn">üéôÔ∏è Hablar</button>
        <button id="btnDetener" class="btn">üîá Detener</button>
        <div class="toggles">
          <label class="toggle"><input id="ttsOn" type="checkbox" checked> Voz</label>
          <label class="toggle"><input id="autoFocus" type="checkbox" checked> Autoseleccionar campo</label>
        </div>
      </div>
    </div>

    <section id="panelRespuesta" class="answer" hidden>
      <div class="tools">
        <button id="copiar" class="chip" title="Copiar">üìã Copiar</button>
        <button id="limpiar" class="chip" title="Limpiar">üßπ Limpiar</button>
      </div>
      <div id="respuesta">‚Äî</div>
    </section>

    <section class="history" id="historial" hidden>
      <h3>Historial</h3>
      <div id="hist"></div>
    </section>
  </main>

  <script>
    // === Config ===
    const API_BASE = "https://apolo-ia.onrender.com"; // cambia si usas FastAPI local
    let recognition = null;
    let history = [];

    // Permiso de voz en m√≥viles tras interacci√≥n
    let userInteracted = false;
    window.addEventListener('click', () => { userInteracted = true; }, { once:true });

    const $ = s => document.querySelector(s);
    const show = el => el.hidden = false;
    const hide = el => el.hidden = true;

    // Saludo inicial
    fetch(API_BASE + "/")
      .then(r => r.json()).then(d => {
        $("#saludo").innerHTML = `<span class="dot live"></span><span>${d.mensaje || "¬°Saludos!"}</span>`;
        speak(d.mensaje);
      })
      .catch(_=>{
        $("#saludo").innerHTML = `<span class="dot"></span><span>Sin conexi√≥n al or√°culo</span>`;
      });

    // Env√≠o
    async function preguntar(texto){
      if(!texto) return;
      $("#btnPreguntar").disabled = true;
      try{
        const r = await fetch(API_BASE + "/preguntar", {
          method:"POST",
          headers:{ "Content-Type": "application/json" },
          body: JSON.stringify({ texto })
        });
        const data = await r.json();
        const resp = data.respuesta || "No tengo respuesta para eso ahora.";
        $("#respuesta").textContent = resp;
        show($("#panelRespuesta"));
        addToHistory(texto, resp);
        speak(resp);
      }catch(e){
        $("#respuesta").textContent = "‚ùå No pude consultar al or√°culo.";
        show($("#panelRespuesta"));
      }finally{
        $("#btnPreguntar").disabled = false;
        if($("#autoFocus").checked) $("#texto").select();
      }
    }

    function addToHistory(q, a){
      history.unshift({q,a});
      const frag = document.createDocumentFragment();
      history.slice(0,6).forEach(item=>{
        const qEl = document.createElement('div'); qEl.className='q'; qEl.textContent="‚Ä¢ "+item.q;
        const aEl = document.createElement('div'); aEl.className='a'; aEl.textContent="‚Ü≥ "+item.a;
        frag.appendChild(qEl); frag.appendChild(aEl);
      });
      $("#hist").innerHTML = ""; $("#hist").appendChild(frag);
      show($("#historial"));
    }

    // TTS
    function speak(text){
      if(!$("#ttsOn").checked) return;
      if(!('speechSynthesis' in window)) return;
      if(!userInteracted) return; // iOS y m√≥viles: requiere gesto
      if(!text) return;

      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-ES";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // STT
    function startSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }

      if(recognition){ recognition.abort(); recognition = null; }
      recognition = new SR();
      recognition.lang = "es-ES";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      $("#saludo").innerHTML = `<span class="dot live"></span><span>üé§ Escuchando‚Ä¶</span>`;
      recognition.start();

      recognition.onresult = e=>{
        const texto = e.results[0][0].transcript;
        $("#texto").value = texto;
        preguntar(texto);
      };
      recognition.onerror = _=>{
        $("#saludo").innerHTML = `<span class="dot"></span><span>No te escuch√©. Intenta de nuevo.</span>`;
      };
      recognition.onend = ()=>{
        $("#saludo").innerHTML = `<span class="dot live"></span><span>Listo</span>`;
      };
    }
    function stopSTT(){ if(recognition){ recognition.abort(); recognition=null; } }

    // UI events
    $("#btnPreguntar").addEventListener('click', ()=> preguntar($("#texto").value.trim()));
    $("#texto").addEventListener('keydown', e=>{
      if(e.key==="Enter") preguntar($("#texto").value.trim());
    });
    $("#btnHablar").addEventListener('click', startSTT);
    $("#btnDetener").addEventListener('click', stopSTT);

    $("#copiar").addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText($("#respuesta").textContent);
        $("#copiar").textContent="‚úÖ Copiado";
        setTimeout(()=>$("#copiar").textContent="üìã Copiar",1200);
      }catch{}
    });
    $("#limpiar").addEventListener('click', ()=>{
      $("#texto").value=""; hide($("#panelRespuesta")); hide($("#historial"));
      history = [];
    });

    // Registrar Service Worker (PWA) ‚Äî ra√≠z
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('service-worker.js'));
    }
  </script>
</body>
</html>
